### Modified code to fix errors, suppress noise and correct the inconsistency in the clade size and separation requirements

Implements corrections set out in comments [#11](https://pubpeer.com/publications/3FB983CC74C0A93394568A373167CE#11), [#12](https://pubpeer.com/publications/3FB983CC74C0A93394568A373167CE#11) and [#15](https://pubpeer.com/publications/3FB983CC74C0A93394568A373167CE#15).

If there a problems reading the jupyter notebook [cladeAnalysis.ipynb](https://github.com/nizzaneela/multi-introduction/blob/corrected_with_relative_size_and_separation_conditions/notebooks/cladeAnalysis.ipynb) on GitHub's browser interface, please inform nizzaneela@fastmail.com. Any other problems should also be reported to the same email.

[stableCoalescence_cladeAnalysis.py](https://github.com/nizzaneela/multi-introduction/blob/corrected_with_relative_size_and_separation_conditions/FAVITES-COVID-Lite/scripts/stableCoalescence_cladeAnalysis.py) is modified from the [original](https://github.com/niemasd/multi-introduction/blob/main/FAVITES-COVID-Lite/scripts/stableCoalescence_cladeAnalysis.py) to correct determination of the stable coalescence, to resample the mutation simulation 1000 times, and output root mutations and additional clade data for a separation constraint of exactly two mutations (the original applied a separation constraint of two or mutations, which seems inconsistent with the text).

[cladeAnalysis.ipynb](https://github.com/nizzaneela/multi-introduction/blob/corrected_with_relative_size_and_separation_conditions/notebooks/cladeAnalysis.ipynb) is modified from the [original](https://github.com/niemasd/multi-introduction/blob/main/notebooks/cladeAnalysis.ipynb) to generate corrected transmission times, sample times and time trees, to run `stableCoalescence_cladeAnalysis.py` for each simulation, and to analyse the clades generated by each resample. Clade analysis is corrected to count two introductions as being compatible with either A and B or C/C and T/T MRCA haplotypes if they both have basal polytomies, similar clade sizes, and a two (or two or more) mutation separation (and a basal polytomy when compatible with A and B or sibling polytomies when compatible with C/C and T/T). The two mutation separation is tested using a model for the upstream phylogeny where times between MRCA and first introduction are expeonentially distributed (expected time $t_1$), and times between first and second introductions are also exponentially distributed (expected time $t_2$). Upstream mutations are simulated using the same molecular clock as in Pekar et al. Two introduction topology frequencies are measured by drawing pairs of simulated phylogenies, with replacement, testing them for basal polytomies, adding upstream mutations to their root mutations and testing them against the separation constraint, and adding $t_2$ to sample and transmission times of the second simulation and testing the relative size constraint.

#### Instructions

Get `coatran_constant` from [CoaTran](https://github.com/niemasd/CoaTran/tree/main):
```
git clone https://github.com/niemasd/CoaTran.git
cd CoaTran
make
sudo mv coatran_constant /usr/local/bin/
```

Move to a directory with at least 300 Gb free disk space.


Fetch the data from Zenodo:
```
for i in {01..22}; do wget "https://zenodo.org/records/6899613/files/simulations_${i}.zip?download=1" -O "simulations_${i}.zip"; done
```

Unpack the data into a subdirectory `simulations` using GNU `parallel`:
```
mkdir -p ./simulations
parallel 'unzip "{}" -d . && mv "{/.}"/* ./simulations && rmdir "{/.}"' ::: simulations_*.zip
```
or without (untested):
```
mkdir -p ./simulations
for z in simulations_*.zip; do unzip "$z" -d . && mv "${z%.*}"/* ./simulations && rmdir "${z%.*}"; done
```

Get [stableCoalescence_cladeAnalysis.py](https://github.com/nizzaneela/multi-introduction/blob/corrected_with_relative_size_and_separation_conditions/FAVITES-COVID-Lite/scripts/stableCoalescence_cladeAnalysis.py) and [cladeAnalysis.ipynb](https://github.com/nizzaneela/multi-introduction/blob/corrected_with_relative_size_and_separation_conditions/notebooks/cladeAnalysis.ipynb) from this branch:
```
curl -L -o stableCoalescence_cladeAnalysis.py "https://raw.githubusercontent.com/nizzaneela/multi-introduction/corrected_with_relative_size_and_separation_conditions/FAVITES-COVID-Lite/scripts/stableCoalescence_cladeAnalysis.py"
curl -L -o cladeAnalysis.ipynb "https://raw.githubusercontent.com/nizzaneela/multi-introduction/corrected_with_relative_size_and_separation_conditions/notebooks/cladeAnalysis.ipynb"
```

Launch the notebook. The number of processers to be used in parallel can be set with the `max_workers` parameter in cells 5 and 13. The notebook can then be run to reproduce the Bayes factors below.

### recCA rooting, separation of two or more mutations
|  |$t_2$ = 0 days | $t_2$ = 1 day | $t_2$ = 2 days | $t_2$ = 4 days | $t_2$ = 7 days | $t_2$ = 14 days | $t_2$ = 28 days |
|---|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| $t_1$ **= 0 days** |0.21 | 0.22 | 0.23 | 0.23 | 0.23 | 0.21 | 0.16 |
| $t_1$ **= 1 day** |0.23 | 0.24 | 0.25 | 0.25 | 0.25 | 0.21 | 0.17 |
| $t_1$ **= 2 days** |0.24 | 0.24 | 0.24 | 0.25 | 0.24 | 0.22 | 0.17 |
| $t_1$ **= 4 days** |0.25 | 0.26 | 0.25 | 0.26 | 0.26 | 0.22 | 0.16 |
| $t_1$ **= 7 days** |0.26 | 0.27 | 0.26 | 0.26 | 0.26 | 0.21 | 0.16 |
| $t_1$ **= 14 days** |0.27 | 0.27 | 0.26 | 0.26 | 0.24 | 0.21 | 0.16 |
| $t_1$ **= 28 days** |0.24 | 0.24 | 0.24 | 0.24 | 0.23 | 0.19 | 0.14 |

### unconstrained rooting, separation of two or more mutations
|  |$t_2$ = 0 days | $t_2$ = 1 day | $t_2$ = 2 days | $t_2$ = 4 days | $t_2$ = 7 days | $t_2$ = 14 days | $t_2$ = 28 days |
|---|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| $t_1$ **= 0 days** |0.21 | 0.21 | 0.22 | 0.23 | 0.22 | 0.20 | 0.16 |
| $t_1$ **= 1 day** |0.22 | 0.23 | 0.24 | 0.24 | 0.24 | 0.20 | 0.16 |
| $t_1$ **= 2 days** |0.23 | 0.23 | 0.23 | 0.24 | 0.23 | 0.21 | 0.16 |
| $t_1$ **= 4 days** |0.24 | 0.25 | 0.24 | 0.25 | 0.25 | 0.21 | 0.15 |
| $t_1$ **= 7 days** |0.25 | 0.26 | 0.25 | 0.24 | 0.25 | 0.20 | 0.15 |
| $t_1$ **= 14 days** |0.25 | 0.25 | 0.24 | 0.24 | 0.22 | 0.19 | 0.14 |
| $t_1$ **= 28 days** |0.22 | 0.22 | 0.22 | 0.22 | 0.20 | 0.17 | 0.13 |

### recCA rooting, separation of exactly two mutations
|  |$t_2$ = 0 days | $t_2$ = 1 day | $t_2$ = 2 days | $t_2$ = 4 days | $t_2$ = 7 days | $t_2$ = 14 days | $t_2$ = 28 days |
|---|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| $t_1$ **= 0 days** |0.16 | 0.16 | 0.17 | 0.17 | 0.16 | 0.13 | 0.10 |
| $t_1$ **= 1 day** |0.17 | 0.17 | 0.18 | 0.17 | 0.17 | 0.13 | 0.10 |
| $t_1$ **= 2 days** |0.18 | 0.17 | 0.17 | 0.17 | 0.16 | 0.13 | 0.09 |
| $t_1$ **= 4 days** |0.17 | 0.17 | 0.17 | 0.17 | 0.16 | 0.13 | 0.08 |
| $t_1$ **= 7 days** |0.16 | 0.17 | 0.16 | 0.15 | 0.15 | 0.11 | 0.07 |
| $t_1$ **= 14 days** |0.14 | 0.14 | 0.13 | 0.12 | 0.11 | 0.09 | 0.06 |
| $t_1$ **= 28 days** |0.09 | 0.09 | 0.09 | 0.09 | 0.08 | 0.06 | 0.04 |

### unconstrained rooting, separation of exactly two mutations
|  |$t_2$ = 0 days | $t_2$ = 1 day | $t_2$ = 2 days | $t_2$ = 4 days | $t_2$ = 7 days | $t_2$ = 14 days | $t_2$ = 28 days |
|---|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| $t_1$ **= 0 days** |0.16 | 0.16 | 0.16 | 0.16 | 0.15 | 0.13 | 0.09 |
| $t_1$ **= 1 day** |0.17 | 0.17 | 0.18 | 0.17 | 0.16 | 0.13 | 0.10 |
| $t_1$ **= 2 days** |0.17 | 0.17 | 0.17 | 0.17 | 0.15 | 0.13 | 0.09 |
| $t_1$ **= 4 days** |0.17 | 0.17 | 0.16 | 0.17 | 0.16 | 0.13 | 0.08 |
| $t_1$ **= 7 days** |0.16 | 0.17 | 0.16 | 0.15 | 0.14 | 0.11 | 0.07 |
| $t_1$ **= 14 days** |0.14 | 0.14 | 0.13 | 0.12 | 0.11 | 0.09 | 0.06 |
| $t_1$ **= 28 days** |0.09 | 0.09 | 0.09 | 0.08 | 0.07 | 0.06 | 0.04 |


### Supplementary code for:

J. E. Pekar, A. Magee, E. Parker, N. Moshiri, K. Izhikevich, J. L. Havens, K. Gangavarapu, L. M. Malpica Serrano, A. Crits-Christoph, N. L. Matteson, M. Zeller, J. I. Levy, J. C. Wang, S. Hughes, J. Lee, H. Park, M.-S. Park, K. Ching Zi Yan, R. T. Pin Lin, M. N. Mat Isa, Y. M. Noor, T. I. Vasylyeva, R. F. Garry, E. C. Holmes, A. Rambaut, M. A. Suchard, K. G. Andersen, M. Worobey, J. O. Wertheim, "The molecular epidemiology of multiple zoonoses of SARS-CoV-2".
